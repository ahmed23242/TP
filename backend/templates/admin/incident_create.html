{% extends "admin/base.html" %}

{% block title %}Créer un incident - Administration des incidents{% endblock %}

{% block page_title %}
Créer un nouvel incident
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'admin_incidents_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Retour à la liste
    </a>
</div>
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Informations de l'incident</h6>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.title.id_for_label }}" class="form-label">Titre *</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.title.errors }}
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.incident_type.id_for_label }}" class="form-label">Type d'incident *</label>
                    {{ form.incident_type }}
                    {% if form.incident_type.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.incident_type.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">Description *</label>
                {{ form.description }}
                {% if form.description.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.description.errors }}
                </div>
                {% endif %}
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.latitude.id_for_label }}" class="form-label">Latitude *</label>
                    {{ form.latitude }}
                    {% if form.latitude.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.latitude.errors }}
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.longitude.id_for_label }}" class="form-label">Longitude *</label>
                    {{ form.longitude }}
                    {% if form.longitude.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.longitude.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.address.id_for_label }}" class="form-label">Adresse</label>
                {{ form.address }}
                {% if form.address.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.address.errors }}
                </div>
                {% endif %}
                <div class="form-text">Si laissée vide, l'adresse sera générée automatiquement à partir des coordonnées.</div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.status.id_for_label }}" class="form-label">Statut</label>
                    {{ form.status }}
                    {% if form.status.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.status.errors }}
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.sync_status.id_for_label }}" class="form-label">Statut de synchronisation</label>
                    {{ form.sync_status }}
                    {% if form.sync_status.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.sync_status.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.photo.id_for_label }}" class="form-label">Photo</label>
                {{ form.photo }}
                {% if form.photo.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.photo.errors }}
                </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.audio.id_for_label }}" class="form-label">Enregistrement audio</label>
                {{ form.audio }}
                {% if form.audio.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.audio.errors }}
                </div>
                {% endif %}
            </div>
            
            <div id="map" class="mb-3" style="height: 300px; width: 100%;"></div>
            
            <div class="text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Enregistrer l'incident
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser la carte
        const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 48.8566, lng: 2.3522 }, // Paris par défaut
            zoom: 13
        });
        
        // Créer un marqueur
        const marker = new google.maps.Marker({
            position: { lat: 48.8566, lng: 2.3522 },
            map: map,
            draggable: true,
            title: 'Position de l\'incident'
        });
        
        // Vérifier s'il y a des coordonnées pré-remplies
        const latField = document.getElementById('{{ form.latitude.id_for_label }}');
        const lngField = document.getElementById('{{ form.longitude.id_for_label }}');
        
        if (latField.value && lngField.value) {
            const position = {
                lat: parseFloat(latField.value),
                lng: parseFloat(lngField.value)
            };
            map.setCenter(position);
            marker.setPosition(position);
        }
        
        // Mettre à jour les champs de formulaire lorsque le marqueur est déplacé
        google.maps.event.addListener(marker, 'dragend', function() {
            const position = marker.getPosition();
            latField.value = position.lat();
            lngField.value = position.lng();
            
            // Obtenir l'adresse depuis les coordonnées (géocodage inversé)
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: position }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    document.getElementById('{{ form.address.id_for_label }}').value = results[0].formatted_address;
                }
            });
        });
        
        // Permettre de cliquer sur la carte pour déplacer le marqueur
        google.maps.event.addListener(map, 'click', function(event) {
            marker.setPosition(event.latLng);
            latField.value = event.latLng.lat();
            lngField.value = event.latLng.lng();
            
            // Obtenir l'adresse depuis les coordonnées (géocodage inversé)
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: event.latLng }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    document.getElementById('{{ form.address.id_for_label }}').value = results[0].formatted_address;
                }
            });
        });
    });
</script>
{% endblock %} 